#first we need to create an object that binds the transcript names to the gene names. For some reason, the gene_ID is not being pulled in even though it is present in the gtf file
library(readr)
library(tximport)
library(GenomicFeatures)
library(rtracklayer)
library(biomaRt)
library(dplyr)

#first we need to convert the gtf to a dataframe on import:
library(biomaRt)
GTF_files <- system.file("extdata", "GTF_files", package="GenomicFeatures")
path <- file.path(GTF_files, "MvBLg_v2.0.gtf")
gtf <- rtracklayer::import(path)
gtf_df=as.data.frame(gtf)
View(gtf_df)

#Genomic features will not accept NA values in the transcript ID or gene ID columns, so next we need to subset the data using dplyr:
CDS_df <- subset(gtf_df, type == "CDS")
exon_df <- subset(gtf_df, type == "exon")
gene_df <- subset(gtf_df, type == "gene")
transcript_df <- subset(gtf_df, type == "transcript")

#now we have a data frame with no NA values in either column. 

#next we need to build the txdb object manually using makeTxDb(). Note that this is somewhat rare, but it's the only way I could get around the issue with the NA values.
#I couldn't get this method to work because the R package expects integer vectors in the transcript_id column, and I wasn't able to change them from character vectors.

#transcripts <- data.frame(
    tx_id=transcript_df$transcript_id,
    tx_chrom=transcript_df$seqnames,
    tx_strand= transcript_df$strand,
    tx_start=transcript_df$start,
    tx_end=transcript_df$end)
#splicings <-  data.frame(
    tx_id=exon_df$transcript_id,
    exon_rank=exon_df$start,
    exon_start=exon_df$start,
    exon_end=exon_df$end)

#txdb <- makeTxDb(transcripts, splicings)

###This is a response from biostars (https://www.biostars.org/p/9485199/) that might get around the issue of the txdb, because it selects by type:
gtf <- rtracklayer::import("/path/to/gtf")
#/ get a unique transcript2gene mapping table.
tx2gene <- unique(data.frame(gtf[gtf$type=="exon"])[,c("transcript_id", "gene_id")])
> head(tx2gene)





TxDb <- makeTxDbFromGFF(file = "C:/Users/Amy/Desktop/MvBLg_v2.0.gff3")
k <- keys(TxDb, keytype = "TXNAME")
tx2gene <- AnnotationDbi::select(TxDb, k, "GENEID", "TXNAME")
head(tx2gene)


#create a named vector to point to the quantification files. We will create a vector of filenames first by reading in a table that contains the sample IDs, and then combining this with dir and "quant.sf.gz"
samples <- read.table(file.path(dir, "samples.txt"), header = TRUE)
samples

#we need to construct a data frame called "tx2gene" that includes two columns, the transcript ID and the gene ID. I think that we can do this from the GFF file:

#check out this tutorial for more information: https://www.hadriengourle.com/tutorials/rna/
